<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Smart PDF Toolbox</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding-bottom: 160px; }
    .thumb-wrapper { display:inline-block; margin:4px; }
    .sticky-actions {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: #ffffff; border-top: 1px solid #e5e7eb;
      padding: 10px 16px; z-index: 9999;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    }
    #pagesList { max-height: 360px; overflow:auto; }
    #thumbs { max-height: 360px; overflow:auto; white-space: normal; }
    .page-row { display:flex; justify-content:space-between; align-items:center; padding:10px 8px; border-bottom:1px solid #eee; background:#fff; border-radius:6px; margin-bottom:8px; }
    .rotate-btn { border: none; background: transparent; cursor: pointer; font-size:18px; }
    .angle-display { margin-left:8px; font-weight:600; color:#333; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h3>Smart PDF Toolbox</h3>
    <div class="mb-3">
      <label for="pdfUpload" class="form-label">Upload PDF</label>
      <input class="form-control" type="file" id="pdfUpload" accept="application/pdf">
    </div>

    <div class="row">
      <div class="col-md-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6>Pages</h6>
          <div>
            <button id="selectAllBtn" class="btn btn-sm btn-outline-primary">Select All</button>
            <button id="clearAllBtn" class="btn btn-sm btn-outline-secondary ms-1">Clear</button>
          </div>
        </div>
        <div id="pagesList" style="height:360px; overflow:auto; border:1px solid #ddd; padding:10px; background:#fdfdfd"></div>
      </div>

      <div class="col-md-6">
        <h6>Preview Thumbnails</h6>
        <div id="thumbs" style="height:360px; overflow:auto; background:#f8f9fa; padding:6px"></div>
      </div>

      <div class="col-md-3">
        <h6>Generated / Actions</h6>
        <ul id="generatedList" class="list-group mb-2"></ul>

        <div class="mb-2">
          <button id="pdfToWordBtn" class="btn btn-outline-secondary btn-sm w-100 mb-1">Export Selected → Word</button>
          <button id="pdfToExcelBtn" class="btn btn-outline-secondary btn-sm w-100">Export Selected → Excel</button>
        </div>

        <div class="small text-muted">Rotate by page numbers (e.g. <code>1,3,5-7</code>) or use per-page buttons to the right of each page.</div>
        <input id="rotatePagesInput" class="form-control form-control-sm mb-1 mt-1" placeholder="e.g. 1,3,5-7">
      </div>
    </div>
  </div>

  <div class="sticky-actions">
    <div class="container d-flex flex-column flex-md-row align-items-start gap-2">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <div class="form-check form-check-inline">
          <input class="form-check-input action-checkbox" type="checkbox" value="compress" id="act_compress">
          <label class="form-check-label" for="act_compress">Compress</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input action-checkbox" type="checkbox" value="merge" id="act_merge">
          <label class="form-check-label" for="act_merge">Merge Selected Pages</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input action-checkbox" type="checkbox" value="split" id="act_split">
          <label class="form-check-label" for="act_split">Split into pages</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input action-checkbox" type="checkbox" value="remove" id="act_remove">
          <label class="form-check-label" for="act_remove">Remove Selected Pages</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input action-checkbox" type="checkbox" value="rotate" id="act_rotate">
          <label class="form-check-label" for="act_rotate">Rotate (by page numbers or per-page)</label>
        </div>

        <select id="rotateAngle" class="form-select form-select-sm ms-2" style="width:auto;">
          <option value="90">90°</option>
          <option value="180">180°</option>
          <option value="270">270°</option>
        </select>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-2 ms-auto">
        <button id="generateBtn" class="btn btn-primary">Generate</button>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
const uploadUrl = "{{ url_for('pdf.smart_upload') }}";
const processUrl = "{{ url_for('pdf.smart_process') }}";
const pdfToWordUrl = "{{ url_for('pdf.pdf_to_word') }}";
const pdfToExcelUrl = "{{ url_for('pdf.pdf_to_excel') }}";
const uploadsPreviewBase = "{{ url_for('pdf.serve_upload', filename='') }}";
const generatedBase = "{{ url_for('pdf.serve_generated', filename='') }}";

let uploadedFilename = '';
let selectedPages = [];
let pageRotations = {};

async function uploadFile(file) {
  const fd = new FormData();
  fd.append('pdf', file);
  const res = await fetch(uploadUrl, { method:'POST', body: fd });
  if (!res.ok) { alert('Upload failed'); return null; }
  const data = await res.json();
  if (data && data.filename) {
    uploadedFilename = data.filename;
    loadPages(data.total_pages);
    loadThumbnails(`${uploadsPreviewBase}${uploadedFilename}`, data.total_pages);
  } else {
    alert('Upload failed');
  }
}

function loadPages(total) {
  const container = document.getElementById('pagesList');
  container.innerHTML = '';
  selectedPages = [];
  pageRotations = {};
  for (let i=1; i<=total; i++) {
    const div = document.createElement('div');
    div.className = 'page-row';
    div.innerHTML = `
      <div>
        <input class="form-check-input page-checkbox me-2" type="checkbox" value="${i}" id="p${i}">
        <label class="form-check-label" for="p${i}">Page ${i}</label>
      </div>
      <div>
        <button class="btn btn-sm btn-outline-secondary rotate-btn" data-page="${i}" title="Rotate page by 90°">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
            <path d="M8 0a.5.5 0 0 1 .5.5V3a.5.5 0 0 1-1 0V.5A.5.5 0 0 1 8 0z"/>
          </svg>
        </button>
        <span id="angle-${i}" class="angle-display">0°</span>
      </div>
    `;
    container.appendChild(div);
  }
  document.querySelectorAll('.page-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
      const val = parseInt(this.value, 10);
      if (this.checked) {
        if (!selectedPages.includes(val)) selectedPages.push(val);
      } else {
        selectedPages = selectedPages.filter(x => x !== val);
      }
    });
  });
  document.querySelectorAll('.rotate-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const p = parseInt(this.getAttribute('data-page'), 10);
      if (!pageRotations[p]) pageRotations[p] = 0;
      pageRotations[p] = (pageRotations[p] + 90) % 360;
      document.getElementById(`angle-${p}`).innerText = pageRotations[p] + '°';
    });
  });
}

async function loadThumbnails(url, total) {
  try {
    const pdf = await pdfjsLib.getDocument(url).promise;
    const thumbs = document.getElementById('thumbs');
    thumbs.innerHTML = '';
    for (let i=1; i<=total; i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 0.7 });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
      const wrapper = document.createElement('div');
      wrapper.className = 'thumb-wrapper';
      wrapper.appendChild(canvas);
      thumbs.appendChild(wrapper);
    }
  } catch (err) {
    console.warn('thumbnail load failed', err);
  }
}

document.getElementById('pdfUpload').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  uploadFile(file);
});

document.getElementById('selectAllBtn').addEventListener('click', () => {
  document.querySelectorAll('.page-checkbox').forEach(cb => { cb.checked = true; cb.dispatchEvent(new Event('change')); });
});

document.getElementById('clearAllBtn').addEventListener('click', () => {
  document.querySelectorAll('.page-checkbox').forEach(cb => { cb.checked = false; cb.dispatchEvent(new Event('change')); });
});

function getCheckedActions() {
  const actions = [];
  document.querySelectorAll('.action-checkbox:checked').forEach(node => actions.push(node.value));
  return actions;
}

function parsePagesInput(str) {
  if (!str) return [];
  const out = new Set();
  str.split(',').map(s => s.trim()).forEach(part => {
    if (!part) return;
    if (part.includes('-')) {
      const [a, b] = part.split('-').map(x => parseInt(x, 10));
      if (!Number.isNaN(a) && !Number.isNaN(b)) {
        for (let i = Math.min(a, b); i <= Math.max(a, b); i++) out.add(i);
      }
    } else {
      const n = parseInt(part, 10);
      if (!Number.isNaN(n)) out.add(n);
    }
  });
  return Array.from(out).sort((a, b) => a - b);
}

document.getElementById('generateBtn').addEventListener('click', async () => {
  const actions = getCheckedActions();
  if (!uploadedFilename) { alert('Please upload a PDF first'); return; }
  if (actions.length === 0) { alert('Select at least one action'); return; }

  const rotatePagesInput = document.getElementById('rotatePagesInput').value;
  const rotatePagesParsed = parsePagesInput(rotatePagesInput);

  const rotations = {};
  for (const [page, angle] of Object.entries(pageRotations)) {
    rotations[String(page)] = angle;
  }
  if (rotatePagesParsed && rotatePagesParsed.length > 0) {
    const globalAngle = parseInt(document.getElementById('rotateAngle').value || '90', 10);
    rotatePagesParsed.forEach(page => {
      const current = rotations[String(page)] || 0;
      rotations[String(page)] = (current + globalAngle) % 360;
    });
  }

  const payload = {
    filename: uploadedFilename,
    actions: actions,
    pages: selectedPages,
    rotations: rotations
  };

  const resp = await fetch(processUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await resp.json();
  const list = document.getElementById('generatedList');
  list.innerHTML = '';
  (data.generated || []).forEach(name => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<span>${name}</span><div>
      <a href='${generatedBase}${name}' target='_blank' class='btn btn-sm btn-info me-2'>Preview</a>
      <a href='${generatedBase}${name}' class='btn btn-sm btn-success me-2' download>Download</a>
      </div>`;
    list.appendChild(li);
  });
});

document.getElementById('pdfToWordBtn').addEventListener('click', async () => {
  if (!uploadedFilename) { alert('Upload a PDF first'); return; }
  if (selectedPages.length === 0) { alert('Select pages to export'); return; }
  const resp = await fetch(pdfToWordUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filename: uploadedFilename, pages: selectedPages })
  });
  const data = await resp.json();
  if (data.generated && data.generated.length) {
    const list = document.getElementById('generatedList');
    data.generated.forEach(name => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `${name} <a class="btn btn-sm btn-success float-end" href="${generatedBase}${name}" download>Download</a>`;
      list.prepend(li);
    });
  } else {
    alert('Conversion failed');
  }
});

document.getElementById('pdfToExcelBtn').addEventListener('click', async () => {
  if (!uploadedFilename) { alert('Upload a PDF first'); return; }
  if (selectedPages.length === 0) { alert('Select pages to export'); return; }
  const resp = await fetch(pdfToExcelUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filename: uploadedFilename, pages: selectedPages })
  });
  const data = await resp.json();
  if (data.generated && data.generated.length) {
    const list = document.getElementById('generatedList');
    data.generated.forEach(name => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `${name} <a class="btn btn-sm btn-success float-end" href="${generatedBase}${name}" download>Download</a>`;
      list.prepend(li);
    });
  } else {
    alert('Conversion failed');
  }
});
</script>
</body>
</html>
